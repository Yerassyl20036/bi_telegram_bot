# Systemd service files for the Telegram Bot application
# Place these files in /etc/systemd/system/ and enable them with:
# sudo systemctl enable telegram-bot.service
# sudo systemctl enable photo-server.service

# File: /etc/systemd/system/telegram-bot.service
[Unit]
Description=Telegram Bot for Power BI Analytics
After=network.target postgresql.service
Wants=postgresql.service

[Service]
Type=simple
User=yerassyl
Group=yerassyl
WorkingDirectory=/home/yerassyl/bi_telegram_bot
Environment=PATH=/home/yerassyl/.local/bin:/usr/local/bin:/usr/bin:/bin
EnvironmentFile=/home/yerassyl/bi_telegram_bot/.env
ExecStart=/usr/bin/python3 main.py
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

# Health check
ExecStartPre=/bin/bash -c 'timeout 60 bash -c "until docker exec power_bi_postgres pg_isready -U bot_user -d power_bi_bot; do sleep 2; done"'

[Install]
WantedBy=multi-user.target

---

# File: /etc/systemd/system/photo-server.service
[Unit]
Description=Photo Server for Telegram Bot
After=network.target

[Service]
Type=simple
User=yerassyl
Group=yerassyl
WorkingDirectory=/home/yerassyl/bi_telegram_bot
Environment=PATH=/home/yerassyl/.local/bin:/usr/local/bin:/usr/bin:/bin
EnvironmentFile=/home/yerassyl/bi_telegram_bot/.env
ExecStart=/usr/bin/python3 photo_server.py
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target

---

# Installation commands (run these on your VPS):

# 1. Create the service files:
sudo tee /etc/systemd/system/telegram-bot.service > /dev/null << 'EOF'
[Unit]
Description=Telegram Bot for Power BI Analytics
After=network.target docker.service
Wants=docker.service

[Service]
Type=simple
User=yerassyl
Group=yerassyl
WorkingDirectory=/home/yerassyl/bi_telegram_bot
Environment=PATH=/home/yerassyl/.local/bin:/usr/local/bin:/usr/bin:/bin
EnvironmentFile=/home/yerassyl/bi_telegram_bot/.env
ExecStartPre=/bin/bash -c 'cd /home/yerassyl/bi_telegram_bot && docker-compose up -d'
ExecStartPre=/bin/bash -c 'timeout 60 bash -c "until docker exec power_bi_postgres pg_isready -U bot_user -d power_bi_bot; do sleep 2; done"'
ExecStart=/usr/bin/python3 main.py
ExecStop=/bin/bash -c 'pkill -f "python.*main.py"'
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

sudo tee /etc/systemd/system/photo-server.service > /dev/null << 'EOF'
[Unit]
Description=Photo Server for Telegram Bot
After=network.target

[Service]
Type=simple
User=yerassyl
Group=yerassyl
WorkingDirectory=/home/yerassyl/bi_telegram_bot
Environment=PATH=/home/yerassyl/.local/bin:/usr/local/bin:/usr/bin:/bin
EnvironmentFile=/home/yerassyl/bi_telegram_bot/.env
ExecStart=/usr/bin/python3 photo_server.py
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

# 2. Reload systemd and enable services:
sudo systemctl daemon-reload
sudo systemctl enable telegram-bot.service
sudo systemctl enable photo-server.service

# 3. Start services:
sudo systemctl start telegram-bot.service
sudo systemctl start photo-server.service

# 4. Check status:
sudo systemctl status telegram-bot.service
sudo systemctl status photo-server.service

# 5. View logs:
sudo journalctl -u telegram-bot.service -f
sudo journalctl -u photo-server.service -f
