name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

env:
  DOCKER_REGISTRY: docker.io
  BOT_IMAGE_NAME: bi-telegram-bot
  PHOTO_IMAGE_NAME: bi-photo-server

jobs:
  lint:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Lint with flake8
      run: |
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  build-and-deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push bot image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.bot
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.BOT_IMAGE_NAME }}:latest
            ${{ secrets.DOCKER_USERNAME }}/${{ env.BOT_IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push photo server image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.photo
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.PHOTO_IMAGE_NAME }}:latest
            ${{ secrets.DOCKER_USERNAME }}/${{ env.PHOTO_IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          timeout: 120s
          command_timeout: 20m
          debug: true
          script: |
            echo "üöÄ Starting deployment process..."
            echo "Deployment triggered by commit: ${{ github.sha }}"
            
            # Set up variables
            export PROJECT_DIR="$HOME/bi_telegram_bot"
            export DOCKER_USERNAME="${{ secrets.DOCKER_USERNAME }}"
            export BOT_IMAGE="${DOCKER_USERNAME}/bi-telegram-bot:latest"
            export PHOTO_IMAGE="${DOCKER_USERNAME}/bi-photo-server:latest"
            
            # Navigate to project directory
            echo "üìÅ Navigating to project directory..."
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "‚ùå Project directory not found. Setting up..."
              mkdir -p "$PROJECT_DIR"
              cd "$PROJECT_DIR"
              git clone https://github.com/${{ github.repository }} .
            else
              cd "$PROJECT_DIR"
              echo "‚úÖ Found project directory"
            fi
            
            # Stop existing services gracefully
            echo "‚èπÔ∏è  Stopping existing services..."
            if [ -f "docker-compose.yml" ]; then
              echo "Stopping Docker containers (exit code 143 is normal)..."
              docker-compose down --timeout 30 2>&1 | grep -v "Process exited with status 143" || true
              echo "‚úÖ Services stopped successfully"
            fi
            
            # Clean up any orphaned processes
            pkill -f "python.*main.py" 2>/dev/null || true
            pkill -f "python.*photo_server.py" 2>/dev/null || true
            
            # Quick Docker cleanup (non-blocking)
            echo "üßπ Cleaning up Docker resources..."
            docker container prune -f --filter "until=1h" || true
            
            # Login to Docker Hub
            echo "üîê Logging into Docker Hub..."
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login --username "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            if [ $? -ne 0 ]; then
              echo "‚ùå Docker login failed"
              exit 1
            fi
            
            # Pull latest code
            echo "üì• Pulling latest code..."
            git fetch origin
            git reset --hard origin/main
            
            # Pull latest Docker images
            echo "üì• Pulling Docker images..."
            docker pull "$BOT_IMAGE"
            docker pull "$PHOTO_IMAGE"
            
            # Set up environment
            echo "üîß Setting up environment..."
            if [ -f ".env.vps" ]; then
              cp .env.vps .env
              echo "‚úÖ Copied VPS environment configuration"
            fi
            echo "DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}" >> .env
            
            # Create necessary directories
            mkdir -p photos
            
            # Start services in stages for better reliability
            echo "üê≥ Starting services..."
            
            # Start PostgreSQL first
            docker-compose up -d postgres
            echo "Waiting for PostgreSQL to start..."
            sleep 15
            
            # Wait for PostgreSQL to be ready
            POSTGRES_READY=false
            for i in {1..20}; do
              if docker exec power_bi_postgres pg_isready -U bot_user -d power_bi_bot 2>/dev/null; then
                echo "‚úÖ PostgreSQL is ready"
                POSTGRES_READY=true
                break
              fi
              echo "Waiting for PostgreSQL... ($i/20)"
              sleep 3
            done
            
            if [ "$POSTGRES_READY" != "true" ]; then
              echo "‚ùå PostgreSQL failed to become ready, checking logs..."
              docker logs power_bi_postgres --tail 20
              echo "Continuing deployment anyway..."
            fi
            
            # Start other services
            echo "Starting bot, photo server, and Grafana..."
            docker-compose up -d telegram-bot photo-server grafana
            echo "Waiting for all services to stabilize..."
            sleep 30
            
            # Final verification with detailed health checks
            echo "üîç Final health checks..."
            
            # Check all containers
            echo "üìä Container status:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            # Check PostgreSQL health
            if docker exec power_bi_postgres pg_isready -U bot_user -d power_bi_bot 2>/dev/null; then
              echo "‚úÖ PostgreSQL is healthy"
            else
              echo "‚ùå PostgreSQL health check failed"
              docker logs power_bi_postgres --tail 10
            fi
            
            # Check bot container
            if docker ps --filter "name=bi-telegram-bot" --filter "status=running" --quiet | grep -q .; then
              echo "‚úÖ Telegram bot container is running"
            else
              echo "‚ùå Telegram bot container is not running"
              docker logs bi-telegram-bot --tail 10 2>/dev/null || echo "No bot logs available"
            fi
            
            # Check photo server
            if docker ps --filter "name=bi-photo-server" --filter "status=running" --quiet | grep -q .; then
              echo "‚úÖ Photo server container is running"
              # Test photo server endpoint
              if curl -f http://localhost:8080/ 2>/dev/null; then
                echo "‚úÖ Photo server is responding"
              else
                echo "‚ö†Ô∏è Photo server may still be starting"
              fi
            else
              echo "‚ùå Photo server container is not running"
              docker logs bi-photo-server --tail 10 2>/dev/null || echo "No photo server logs available"
            fi
            
            # Check Grafana
            if docker ps --filter "name=power_bi_grafana" --filter "status=running" --quiet | grep -q .; then
              echo "‚úÖ Grafana container is running"
            else
              echo "‚ùå Grafana container is not running"
              docker logs power_bi_grafana --tail 10 2>/dev/null || echo "No Grafana logs available"
            fi
            
            RUNNING_CONTAINERS=$(docker ps --filter "status=running" --format "{{.Names}}" | grep -E "power_bi_postgres|bi-telegram-bot|bi-photo-server|power_bi_grafana" | wc -l)
            echo "üìä Running containers: $RUNNING_CONTAINERS/4"
            
            if [ "$RUNNING_CONTAINERS" -ge 3 ]; then
              echo "‚úÖ Core services are operational"
            else
              echo "‚ö†Ô∏è Some services failed to start properly"
              echo "üîç Checking for any error logs..."
              docker-compose logs --tail 5
            fi
            
            # Final verification
            echo "üìä Final service status:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            echo "üéâ DEPLOYMENT COMPLETED SUCCESSFULLY!"
            echo "üåê Services available at:"
            echo "   - Grafana: http://$(hostname -I | awk '{print $1}'):3000"
            echo "   - Photo Server: http://$(hostname -I | awk '{print $1}'):8080"
            echo "   - PostgreSQL: $(hostname -I | awk '{print $1}'):5432"
